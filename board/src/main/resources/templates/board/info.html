<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
<meta charset="UTF-8">
<title>상세페이지</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
	<div class="container mt-5" layout:fragment="content">
		<span class="fw-bolder fs-4">상세보기</span>
		<div class="card p-0 mt-2">
			<table class="table m-0">
				<tbody>
					<tr>
						<th class="table-danger w-25 text-center">글번호</th>
						<td th:text="${board.bno}"></td>
					</tr>
					<tr>
						<th class="table-danger text-center">제목</th>
						<td th:text="${board.title}"></td>
					</tr>
					<tr>
						<th class="table-danger text-center">내용</th>
						<td th:text="${board.content}"></td>
					</tr>
					<tr>
						<th class="table-danger text-center">작성자</th>
						<td th:text="${board.writer}"></td>
					</tr>
					<tr>
						<th class="table-danger text-center">작성일</th>
						<td th:text="${#dates.format(board.regdate, 'yyyy-MM-dd')}"></td>
					</tr>
					<tr>
						<th class="table-danger text-center">수정일</th>
						<td th:text="${board.updatedate} == ${board.regdate} ? '' : ${#dates.format(board.updatedate, 'yyyy-MM-dd')}"></td>
					</tr>
				</tbody>
			</table>
		</div>
		<div class="text-center m-4">
			<button class="btn btn-info" th:onclick="|location.href='/board/mod/${board.bno}'|">수정</button>
			<button class="btn btn-danger" th:onclick="|location.href='/board/delete?bno=${board.bno}'|">삭제</button>
			<button class="btn btn-light" type="button" onclick="location.href='/board/list'">목록으로</button>
		</div>
		
		<div class="card p-0 mt-2">
			<div class="card-header fw-bolder">댓글 [[${board.replyCnt}]]개</div>
			<table class="table m-0 text-center replyTbl">
				<tbody>
					<tr th:each="rep : ${replies}">
						<td th:text="${rep.rno}"></td>
						<td th:text="${rep.reply}" class="w-50 text-start ps-4"></td>
						<td th:text="${rep.replyer}"></td>
						<td th:text="${rep.updatedate} == null ? ${#dates.format(rep.replydate, 'yyyy-MM-dd')} : ${#dates.format(rep.updatedate, 'yyyy-MM-dd')}"></td>
						<td><button class="btn btn-outline-danger btn-sm replyDelBtn" th:attr="data-rno=|${rep.rno}|">x</button></td>
					</tr>
				</tbody>
			</table>
		</div>
		
		<!-- 댓글 페이지네이션 추가 -->
		<nav class="d-flex justify-content-center mt-4">
	  	<ul class="pagination">
		    <li class="page-item" th:classappend="${paging.startPage} == 1 ? disabled"> <!-- th:classappend 사용하면 클래스 추가로 설정 가능 -->
		    	<a class="page-link" th:href="'/board/list/' + ${board.bno} + '?page=' + ${paging.startPage - 1}">이전</a>
		    </li>
	
		    <li th:each="num : *{#numbers.sequence(paging.startPage, paging.endPage)}"
		        class="page-item-danger"
		        th:classappend="${num} == ${paging.page} ? active"> <!-- numbers.sequence(start, end) : start~end까지의 배열을 만들어줌 -->
		        
		        <a class="page-link" th:text="${num}"
		        	th:href="'/board/list/' + ${board.bno} + '?page=' + ${num}">2</a>
		    </li>
	
		    <li class="page-item" th:classappend="${paging.endPage} == ${paging.lastPage} ? disabled">
		    	<a class="page-link" th:href="'/board/list/' + ${board.bno} + '?page=' + ${paging.endPage + 1}">다음</a>
		    </li>
		  </ul>
		</nav>
		
		<script th:inline="javascript"> // th:inline = thymeleaf 스크립트 인식
			
			// addFlashAttribute 사용하는 경우 param 빼고 쓰면 됨.
			if([[${modResult}]]) {
				alert("게시글이 수정되었습니다.");
			}
			
			// window.addEventListener("DOMContentLoaded", () => { getReply(); });
			// 댓글 가져오기 예시 (fetch 이용)
			function getReply(){
				const url = '/replies/pages/2/1';
				fetch(url)
				.then(resolve => resolve.json())
				.then(result => {});
			}
			
			// 댓글 결과 처리
			//function getReplyProc(result){};
			
			// 댓글 삭제 처리
			window.addEventListener("DOMContentLoaded", () => {
				document.querySelector('.replyTbl').addEventListener('click', () => { // 핸들러 지정하지 않아도 event 전역 객체로 사용 가능
					console.log('target: ' + event.target);
					if(event.target.classList.contains('replyDelBtn')){
						console.log(event.target.dataset.rno);
						const tr = event.target.closest('tr');
						const rno = event.target.dataset.rno; // 사용자속성 data-rno
						const url = `/replies/${rno}`; //////// replyController 만들어 연결하면 됨.
						
						fetch(url, {method: 'delete'})
						.then(resolve => resolve.text()) // String 타입으로 변환
						.then(result => {
						console.log(result);
						if(result == 'success'){
							tr.remove();							
						}
						});
					}
				});
			});
		</script>
		
	</div>
</body>
</html>